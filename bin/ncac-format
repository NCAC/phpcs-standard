#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * NCAC Code Formatter
 *
 * This executable runs the complete NCAC formatting workflow:
 * 1. PHP-CS-Fixer (complex transformations)
 * 2. PHPCBF (NCAC-specific formatting)
 * 3. PHPCS validation (report remaining issues)
 *
 * Usage:
 *   ncac-format [path]
 *   ncac-format src/
 *   ncac-format --dry-run src/
 */

// Find the autoloader
$autoload_paths = [
  __DIR__ . '/../vendor/autoload.php',  // When used as root package
  __DIR__ . '/../../../autoload.php',    // When used as dependency
];

$autoload_found = false;
foreach ($autoload_paths as $autoload_path) {
  if (file_exists($autoload_path)) {
    require_once $autoload_path;
    $autoload_found = true;
    break;
  }
}

if (!$autoload_found) {
  fwrite(\STDERR, "Error: Unable to find Composer autoloader.\n");
  fwrite(\STDERR, "Please run: composer install\n");
  exit(1);
}

// Find the project root (where composer.json is)
// Start from current working directory (not from __DIR__)
function find_project_root(): string {
  $current = getcwd();
  $max_levels = 10;

  for ($i = 0; $i < $max_levels; $i++) {
    if (file_exists($current . '/composer.json')) {
      return $current;
    }
    $parent = \dirname($current);
    if ($parent === $current) {
      break;
    }
    $current = $parent;
  }

  // Fallback to current directory if no composer.json found
  return getcwd();
}

$project_root = find_project_root();
chdir($project_root);

// Parse arguments
$dry_run = false;
$target_path = '.';
$args = \array_slice($argv, 1);

foreach ($args as $arg) {
  if ($arg === '--dry-run') {
    $dry_run = true;
  } elseif ($arg === '--help' || $arg === '-h') {
    echo <<<HELP
NCAC Code Formatter

Usage: ncac-format [--dry-run] [path]

Options:
  --dry-run    Preview changes without applying them
  --help       Show this help message

Examples:
  ncac-format src/              Format all files in src/
  ncac-format --dry-run src/    Preview changes in src/
  ncac-format                   Format all files in current directory

HELP;
    exit(0);
  } else {
    $target_path = $arg;
  }
}

// Colors
\define('GREEN', "\033[0;32m");
\define('YELLOW', "\033[1;33m");
\define('BLUE', "\033[0;34m");
\define('RED', "\033[0;31m");
\define('NC', "\033[0m"); // No Color

echo "\n";
echo BLUE . 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—' . NC . "\n";
echo BLUE . 'â•‘ NCAC Code Quality Workflow                                                  â•‘' . NC . "\n";
echo BLUE . 'â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£' . NC . "\n";

// Truncate target path if too long to fit in the box
$max_path_length = 60;
$display_path = \strlen($target_path) > $max_path_length
  ? '...' . \substr($target_path, -($max_path_length - 3))
  : $target_path;
$padding = \max(0, 70 - \strlen($display_path));

echo BLUE . 'â•‘ Target: ' . $display_path . str_repeat(' ', $padding) . 'â•‘' . NC . "\n";
if ($dry_run) {
  echo BLUE . 'â•‘ Mode: DRY RUN (preview only)                                                 â•‘' . NC . "\n";
}
echo BLUE . 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' . NC . "\n";
echo "\n";

// Find tool executable (check multiple vendor locations)
function find_tool(string $tool_name, string $project_root): ?string {
  $possible_paths = [
    $project_root . '/vendor/bin/' . $tool_name,
    __DIR__ . '/../vendor/bin/' . $tool_name,
    __DIR__ . '/../../bin/' . $tool_name,
  ];

  foreach ($possible_paths as $path) {
    if (file_exists($path)) {
      return $path;
    }
  }

  // Try using 'which' command as fallback
  $which_result = shell_exec("which {$tool_name} 2>/dev/null");
  if ($which_result) {
    return trim($which_result);
  }

  return null;
}

// Check if tools are available
$php_cs_fixer_path = find_tool('php-cs-fixer', $project_root);
$phpcbf_path = find_tool('phpcbf', $project_root);
$phpcs_path = find_tool('phpcs', $project_root);

if (!$php_cs_fixer_path) {
  echo RED . 'âŒ php-cs-fixer not found. Run: composer require --dev friendsofphp/php-cs-fixer' . NC . "\n";
  exit(1);
}

if (!$phpcbf_path) {
  echo RED . 'âŒ phpcbf not found. Run: composer require --dev squizlabs/php_codesniffer' . NC . "\n";
  exit(1);
}

if (!$phpcs_path) {
  echo RED . 'âŒ phpcs not found. Run: composer require --dev squizlabs/php_codesniffer' . NC . "\n";
  exit(1);
}

// Determine PHP-CS-Fixer config
$config_file = '';
if (file_exists('.php-cs-fixer.php')) {
  $config_file = '.php-cs-fixer.php';
} elseif (file_exists('vendor/ncac/phpcs-standard/.php-cs-fixer.dist.php')) {
  $config_file = 'vendor/ncac/phpcs-standard/.php-cs-fixer.dist.php';
} else {
  echo YELLOW . 'âš ï¸  No PHP-CS-Fixer config found, using defaults' . NC . "\n";
}

/**
 * Execute a command and return the exit code
 */
function execute_command(string $command): int {
  passthru($command, $exit_code);
  return $exit_code;
}

// Step 1: PHP-CS-Fixer
echo BLUE . 'âœ Step 1/3: Applying PHP-CS-Fixer...' . NC . "\n";
$php_cs_fixer_command = escapeshellcmd($php_cs_fixer_path) . ' fix ' . escapeshellarg($target_path);
if ($config_file) {
  $php_cs_fixer_command .= ' --config=' . escapeshellarg($config_file);
}
if ($dry_run) {
  $php_cs_fixer_command .= ' --dry-run --diff';
}
execute_command($php_cs_fixer_command . ' || true');
echo GREEN . 'âœ“ PHP-CS-Fixer complete' . NC . "\n";
echo "\n";

// Step 2: PHPCBF
echo BLUE . 'âœ Step 2/3: Applying PHPCBF (NCAC-specific)...' . NC . "\n";
if ($dry_run) {
  $phpcbf_command = escapeshellcmd($phpcs_path) . ' --standard=NCAC --report=diff ' . escapeshellarg($target_path);
} else {
  $phpcbf_command = escapeshellcmd($phpcbf_path) . ' --standard=NCAC ' . escapeshellarg($target_path);
}
execute_command($phpcbf_command . ' || true');
echo GREEN . 'âœ“ PHPCBF complete' . NC . "\n";
echo "\n";

// Step 3: PHPCS validation
echo BLUE . 'âœ Step 3/3: Validating with PHPCS...' . NC . "\n";
$phpcs_command = escapeshellcmd($phpcs_path) . ' --standard=NCAC ' . escapeshellarg($target_path);
$validation_result = execute_command($phpcs_command);

echo "\n";
if ($validation_result === 0) {
  echo GREEN . 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—' . NC . "\n";
  echo GREEN . 'â•‘ ğŸ‰ Success! No violations found                                             â•‘' . NC . "\n";
  echo GREEN . 'â•‘ Your code is fully compliant with the NCAC standard                         â•‘' . NC . "\n";
  echo GREEN . 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' . NC . "\n";
  exit(0);
} else {
  echo YELLOW . 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—' . NC . "\n";
  echo YELLOW . 'â•‘ âš ï¸  Some violations remain                                                   â•‘' . NC . "\n";
  echo YELLOW . 'â•‘                                                                              â•‘' . NC . "\n";
  echo YELLOW . 'â•‘ The workflow fixed most issues, but some require manual intervention.       â•‘' . NC . "\n";
  echo YELLOW . 'â•‘ Please review the violations above and fix them manually.                   â•‘' . NC . "\n";
  echo YELLOW . 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' . NC . "\n";

  if (!$dry_run) {
    echo "\n";
    echo BLUE . 'ğŸ’¡ Tips:' . NC . "\n";
    echo "  - Some violations cannot be auto-fixed (e.g., naming conventions)\n";
    echo "  - Review each violation and apply manual fixes\n";
    echo "  - Run this script again after manual fixes\n";
  }

  exit(1);
}
